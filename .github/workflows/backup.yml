name: Daily Backup

on:
  schedule:
    # Run at midnight UTC every day
    - cron: "0 0 * * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for complete backup

      - name: Setup SSH for backup repo
        env:
          BACKUP_DEPLOY_KEY: ${{ secrets.BACKUP_DEPLOY_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "${BACKUP_DEPLOY_KEY}" > ~/.ssh/backup_key
          chmod 600 ~/.ssh/backup_key
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          # Configure SSH to use this key for the backup repo
          cat >> ~/.ssh/config << EOF
          Host github-backup
            HostName github.com
            User git
            IdentityFile ~/.ssh/backup_key
            IdentitiesOnly yes
          EOF

      - name: Push to backup repository
        run: |
          BACKUP_DATE=$(date +%Y-%m-%d)

          # Configure git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Remove workflow files from the commit (deploy keys can't push them)
          # This creates a temporary commit without workflows for the backup
          rm -rf .github/workflows
          git add -A
          git commit -m "Backup ${BACKUP_DATE} (workflows excluded for deploy key compatibility)" --allow-empty

          # Add backup remote
          git remote add backup git@github-backup:chrismlittle123/check-my-process-backup.git

          # Push main branch only (skip historical tags - they contain workflow files)
          git push backup HEAD:main --force

          # Create a dated backup tag on the current (workflow-free) commit
          git tag -f "backup-${BACKUP_DATE}"
          git push backup "backup-${BACKUP_DATE}" --force

          echo "âœ… Backup completed for ${BACKUP_DATE}"
